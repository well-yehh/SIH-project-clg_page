<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>College Portal â€” Marks</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fb;
      margin: 0;
      padding: 20px;
    }
    header {
      text-align: center;
      padding: 15px;
      background: #2d4b9a;
      color: white;
      border-radius: 10px;
    }
    .filters {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    select, input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #2d4b9a;
      color: white;
    }
    .summary {
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      line-height: 1.6;
    }
    .actions button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #2d4b9a;
      color: white;
    }
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .chart-box {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* ---------- PRINT SETTINGS ---------- */
    @media print {
      @page {
        size: A4 landscape; /* Always landscape */
        margin: 10mm;
      }

      body {
        background: white;
      }

      header {
        background: #2d4b9a !important;
        color: white !important;
      }

      .charts {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }

      .chart-box {
        padding: 10px;
        box-shadow: none;
      }

      canvas {
        max-width: 250px !important;
        max-height: 180px !important;
      }

      .actions {
        display: none; /* Hide buttons in print */
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>MARKS PORTAL</h1>
  </header>

  <div class="filters">
    <select id="semesterFilter">
      <option value="all">All Semesters</option>
      <option value="1">Semester 1</option>
      <option value="2">Semester 2</option>
      <option value="3">Semester 3</option>
    </select>
    <select id="examFilter">
      <option value="all">All Exams</option>
      <option value="sessional">Sessional</option>
      <option value="put">PUT</option>
      <option value="midterm">Midterm</option>
      <option value="internal">Internal</option>
      <option value="lab">Lab</option>
      <option value="final">Final</option>
    </select>
    <input type="text" id="searchBox" placeholder="Search Subject...">
  </div>

  <table id="marksTable">
    <thead>
      <tr>
        <th>Code</th>
        <th>Subject</th>
        <th>Max Marks</th>
        <th>Obtained</th>
        <th>Percentage</th>
        <th>Grade</th>
        <th>Exam</th>
        <th>Semester</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary" id="summary"></div>

  <div class="actions">
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="window.print()">Print</button>
  </div>

  <div class="charts">
    <div class="chart-box">
      <h3>Subject Performance</h3>
      <canvas id="barChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Overall Distribution</h3>
      <canvas id="pieChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Semester-wise Trend</h3>
      <canvas id="lineChart"></canvas>
    </div>
  </div>

  <script>
    const marksData = [
      {code:'CS101', subject:'Programming', max:100, obtained:85, exam:'sessional', sem:'1'},
      {code:'CS101', subject:'Programming', max:100, obtained:75, exam:'put', sem:'1'},
      {code:'CS102', subject:'Maths', max:100, obtained:92, exam:'final', sem:'1'},
      {code:'CS201', subject:'DBMS', max:100, obtained:81, exam:'midterm', sem:'2'},
      {code:'CS201', subject:'DBMS', max:100, obtained:90, exam:'final', sem:'2'},
      {code:'CS202', subject:'OS', max:100, obtained:76, exam:'lab', sem:'2'},
      {code:'CS301', subject:'AI', max:100, obtained:88, exam:'internal', sem:'3'},
      {code:'CS301', subject:'AI', max:100, obtained:95, exam:'final', sem:'3'}
    ];

    const tbody = document.querySelector("#marksTable tbody");
    const semesterFilter = document.getElementById("semesterFilter");
    const examFilter = document.getElementById("examFilter");
    const searchBox = document.getElementById("searchBox");
    const summary = document.getElementById("summary");

    function renderTable() {
      tbody.innerHTML = "";
      let filtered = marksData.filter(m =>
        (semesterFilter.value === "all" || m.sem === semesterFilter.value) &&
        (examFilter.value === "all" || m.exam === examFilter.value) &&
        (m.subject.toLowerCase().includes(searchBox.value.toLowerCase()))
      );

      let total = 0, obtained = 0;
      filtered.forEach(m => {
        let perc = ((m.obtained / m.max) * 100).toFixed(1);
        let grade = perc >= 90 ? 'A+' : perc >= 80 ? 'A' : perc >= 70 ? 'B' : perc >= 60 ? 'C' : 'D';
        tbody.innerHTML += `<tr><td>${m.code}</td><td>${m.subject}</td><td>${m.max}</td><td>${m.obtained}</td><td>${perc}%</td><td>${grade}</td><td>${m.exam}</td><td>${m.sem}</td></tr>`;
        total += m.max;
        obtained += m.obtained;
      });

      let overallPerc = total ? ((obtained / total) * 100).toFixed(2) : 0;
      let overallCGPA = (overallPerc / 9.5).toFixed(2);

      let semWise = {};
      filtered.forEach(m => {
        if (!semWise[m.sem]) semWise[m.sem] = {obt:0,max:0};
        semWise[m.sem].obt += m.obtained;
        semWise[m.sem].max += m.max;
      });

      let semSummary = "";
      Object.keys(semWise).sort().forEach(s => {
        let perc = ((semWise[s].obt / semWise[s].max) * 100).toFixed(2);
        let sgpa = (perc / 9.5).toFixed(2);
        semSummary += `<br>Semester ${s} SGPA: ${sgpa}`;
      });

      summary.innerHTML = `
        <b>Total Marks:</b> ${obtained}/${total} (${overallPerc}%)
        <br><b>Overall CGPA:</b> ${overallCGPA}
        ${semSummary}
      `;

      updateCharts(filtered);
    }

    function exportCSV() {
      let rows = [['Code','Subject','Max','Obtained','Percentage','Grade','Exam','Semester']];
      document.querySelectorAll('#marksTable tbody tr').forEach(tr => {
        let cells = Array.from(tr.querySelectorAll('td')).map(td => td.innerText);
        rows.push(cells);
      });
      let csv = rows.map(r => r.join(",")).join("\n");
      let blob = new Blob([csv], { type: 'text/csv' });
      let a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'marks.csv';
      a.click();
    }

    let barChart, pieChart, lineChart;

    function updateCharts(filtered) {
      let labels = filtered.map(m => m.subject + ' ('+m.exam+')');
      let obtainedData = filtered.map(m => m.obtained);
      let maxData = filtered.map(m => m.max);

      if (barChart) barChart.destroy();
      barChart = new Chart(document.getElementById('barChart'), {
        type:'bar',
        data:{labels:labels, datasets:[
          {label:'Obtained', data:obtainedData, backgroundColor:'rgba(54,162,235,0.6)'},
          {label:'Max', data:maxData, backgroundColor:'rgba(255,99,132,0.6)'}
        ]}
      });

      let totalObt = filtered.reduce((sum,m)=>sum+m.obtained,0);
      let totalRem = filtered.reduce((sum,m)=>sum+(m.max-m.obtained),0);
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById('pieChart'), {
        type:'pie',
        data:{labels:['Obtained','Remaining'], datasets:[{data:[totalObt,totalRem], backgroundColor:['#36A2EB','#FF6384']}]}
      });

      let semWise = {};
      filtered.forEach(m=>{
        if(!semWise[m.sem]) semWise[m.sem]={obt:0,max:0};
        semWise[m.sem].obt+=m.obtained;
        semWise[m.sem].max+=m.max;
      });
      let semLabels = Object.keys(semWise).sort();
      let semPerc = semLabels.map(s=>((semWise[s].obt/semWise[s].max)*100).toFixed(2));

      if(lineChart) lineChart.destroy();
      lineChart = new Chart(document.getElementById('lineChart'), {
        type:'line',
        data:{labels:semLabels, datasets:[{label:'Semester %', data:semPerc, fill:false, borderColor:'blue'}]}
      });
    }

    semesterFilter.onchange = renderTable;
    examFilter.onchange = renderTable;
    searchBox.onkeyup = renderTable;

    renderTable();
  </script>
</body>
</html>
